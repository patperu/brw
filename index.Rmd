---
title: "Entwicklung der Bodenrichtwerte in Berlin (2002 - 2017)"
author: "Patrick Hausmann"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_caption: yes
    highlight: tango
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 3
---

# Einleitung

Die Daten stammen aus dem [FIS-Broker](http://www.stadtentwicklung.berlin.de/geoinformation/fis-broker/) der Senatsverwaltung für Stadtentwicklung und Wohnen.

Zur Arbeit mit dem FIS-Broker siehe auch den Vortrag ["Daten aus dem FIS-Broker"](https://jochenklar.de/files/talks/odd-2017/#1) von Jochen Klar zum ODD 2017 in Berlin.

# Setup

```{r setup, include = TRUE}

library("gdalUtils")
library("ggplot2")
suppressPackageStartupMessages(library("dplyr"))
library("leaflet")
suppressPackageStartupMessages(library("viridis"))
library("tibble")
library("scales")
library("sf")

knitr::opts_chunk$set(echo = TRUE)

options(width = 140, stringsAsFactors = FALSE)

```

# Download der XML Dateien und konvertieren zu SHP

```{r get_xml, eval = TRUE}

get_xml <- function(years) {

  p <- progress_estimated(length(years))

  purrr::map(years, function(year) {

    base_url <- sprintf("http://fbinter.stadt-berlin.de/fb/wfs/geometry/senstadt/re_brw%s", year)
    url <- paste0(base_url, "?REQUEST=GetFeature&SERVICE=WFS&VERSION=2.0.0&TYPENAMES=GML2")
  
    fname <- sprintf("./data/brw%s.xml", year)
    
    result <- httr::GET(url, httr::write_disk(path = fname, overwrite = TRUE))
    
    #if (result$status_code > 201) {
    #      stop(result$status_code, ": downloading file; file may not exist", call. = FALSE)
    #}
  
     dest_file <- sprintf("./data/brw%s.shp", year)
   
     ogr2ogr(src_datasource_name = fname,
             dst_datasource_name = dest_file,
             f = "ESRI Shapefile",
             s_srs = "EPSG:25833",
             t_srs = "WGS84",
             overwrite = TRUE)
     
      Sys.sleep(.5)
      p$tick()$print()
  })

}

```

```{r read_shp}

read_brw <- function() {

  files <- dir("./data/", pattern = ".shp", full.names = TRUE)

  purrr::map(files, function(file) { 
                # see https://github.com/edzer/sfr/issues/5
                     st_read(file, 
                             quiet = TRUE, 
                             stringsAsFactors = FALSE, 
                             options = "ENCODING=UTF-8") %>% 
                     select(spatial_al, spatial_ty, BEZIRK, BRW, 
                            NUTZUNG, STICHTAG, GFZ, BEITRAGSZU, geometry) %>% 
                     mutate(BRW = as.integer(BRW), 
                            year = as.numeric(format(as.Date(STICHTAG), "%Y")))
  }) -> out

}

```

# Import der Shapefiles

```{r build_shp, eval = TRUE}

microbenchmark::microbenchmark(get_xml(2002:2017), times = 1L)

dat <- read_brw()

# dat %>% 
#  bind_rows()
#  Error in .subset2(x, i, exact = exact) : 
#   attempt to select less than one element in get1index

dat <- do.call("rbind", dat)

class(dat)

glimpse(dat, width = 110)

head(dat, 2) %>% knitr::kable()

```

# Zuordnung der Wohnlage im Jahr 2017

```{r}

wl_gr <- c("M", "E", "G", "E/M", "M/E", "G/M", "G/E", "M/G", "E/G")

match_WL <- function(x, y) { 
                      z <- sum(match(c(x,y), wl_gr), na.rm = TRUE)
                      z <- ifelse(z == 0, NA, z)
                      z }

wl <- readr::read_tsv("tabula-brw-liste-geschlossene-bauweise-2017.tsv", 
                      col_names = FALSE, skip= 1) %>%
        select(X1, X6, X7) %>%
        filter(!is.na(X1), X1 != "GFZ") %>%
        purrr::set_names(c("spatial_al", "WL_A", "WL_B")) %>%  
        mutate(spatial_al = as.numeric(spatial_al)) %>%  
        rowwise() %>%
        mutate(Wohnlage = match_WL(WL_A, WL_B),
               Wohnlage = wl_gr[Wohnlage]) %>%
        select(spatial_al, Wohnlage) %>%
        arrange(spatial_al)

dat <- left_join(dat, wl, by="spatial_al")

```

```{r}

table(dat$GFZ, dat$Wohnlage) %>% knitr::kable()

```

```{r save_rds}

saveRDS(dat, file = "brw_data.rds")

```

# Anzahl der Bodenrichtwertzonen nach Bezirken

```{r}
  table(dat$BEZIRK, dat$year) %>% knitr::kable()
```

# Anzahl der Bodenrichtwertzonen nach Art der Nutzung

```{r}
 table(dat$NUTZUNG, dat$year) %>% knitr::kable()
```

# Berechnung von Kennzahlen

```{r eval = TRUE}

z <- tbl_df(dat) %>% 
        group_by(BEZIRK, NUTZUNG, GFZ, year) %>% 
        summarise(count = n(),
                  q25 = quantile(BRW, 0.25, na.rm = TRUE),
                  q75 = quantile(BRW, 0.75, na.rm = TRUE),
                  q95 = quantile(BRW, 0.95, na.rm = TRUE),
                  iqr = IQR(BRW, na.rm = TRUE),
                  mean = mean(BRW, na.rm = TRUE),
                  med = median(BRW, na.rm = TRUE))  %>%
        filter(!is.na(BEZIRK)) %>%
        ungroup()

tail(z, 10) %>% knitr::kable()

```

# In der Nutzung `W - Wohngebiet`

```{r, fig.height=10, fig.width=12}

p0 <- ggplot(filter(z, year >= 2008, NUTZUNG == "W - Wohngebiet"),
       aes(factor(year), mean, colour = "BEZIRK", group = "BEZIRK"))
p0 <- p0 + geom_line()
p0 <- p0 + facet_grid(factor(GFZ) ~ BEZIRK, scales = "free")
p0 <- p0 + theme(axis.text.x  = element_text(angle=90, vjust=0.5, size = 8),
                 axis.text.y  = element_text(size = 8), 
                 legend.position="none")
p0 <- p0 + labs(x = "",
                y = "Durchschnitt in  €",
                title = "Bodenrichtwerte in der Nutzung 'W - Wohngebiet' (2008-2017)",
                subtitle = "",
                caption = "Quelle: FIS-Broker / Gutachterausschuss für Grundstückswerte in Berlin")
p0

```

# In der Nutzung `M2 - Mischgebiet`

```{r, fig.height=10, fig.width=12}

p1 <- ggplot(filter(z, year >= 2008, NUTZUNG == "M2 - Mischgebiet"),
       aes(factor(year), mean, colour = "BEZIRK", group = "BEZIRK"))
p1 <- p1 + geom_line()
p1 <- p1 + facet_grid(factor(GFZ) ~ BEZIRK, scales = "free")
p1 <- p1 + theme(axis.text.x  = element_text(angle=90, vjust=0.5, size = 8),
                 axis.text.y  = element_text(size = 8),
                 legend.position="none")
p1 <- p1 + labs(x = "",
                y = "Durchschnitt in €",
                title = "Bodenrichtwerte in der Nutzung 'M2 - Mischgebiet' (2008-2017)",
                subtitle = "",
                caption = "Quelle: FIS-Broker / Gutachterausschuss für Grundstückswerte in Berlin")
p1
```

# Karte der Bodenrichtwerte im Jahr 2017 - BRW <= 8.000

```{r fig.height=15, fig.width=15, eval = TRUE}

brw <- st_read("./data/brw2017.shp", 
               quiet = TRUE, 
               stringsAsFactors = FALSE,
               options = "ENCODING=UTF-8") %>%
       filter(BRW <= 8000)

pal <- colorNumeric(
  palette = viridis_pal()(10),
  domain = brw$BRW
)

popup <- paste0("<b>", brw$spatial_al, " - ",
                       brw$NUTZUNG , " - ",
                       brw$GFZ, " - ", 
                       brw$BRW, " Euro/qm")

leafMap <- leaflet(height = "800px", width = "1000px") %>%
  setView(lng = 13.383, lat = 52.516, zoom = 11) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data = brw,
              stroke = TRUE,
              dashArray = 1,
              weight = 1.5,
              color = "white",
              smoothFactor = 0.20,
              fillOpacity = 0.60,
              fillColor = ~pal(brw$BRW),
              highlightOptions = highlightOptions(color = "steelblue", 
                                                  weight = 4,
                                                  bringToFront = FALSE),
              popup = popup,
              group = "Bodenrichtwerte") %>%
  addLegend("bottomright",
            pal = pal,
            values = brw$BRW,
            title = "Euro/qm",
            labFormat = labelFormat(suffix = " "),
            opacity = 1)

leafMap

```

# Verteilung der BRW nach GFZ

Vorlage der Grafik ist [Mapping San Francisco home prices using R](http://urbanspatialanalysis.com/dataviz-tutorial-mapping-san-francisco-home-prices-using-r/)

WIP!

```{r violin_plot, fig.height=10, fig.width=12}

p1 <- filter(dat, 
             NUTZUNG == "W - Wohngebiet", 
             GFZ %in% c(0.4, 1, 1.2, 2.5) )

p1 <- p1[which(p1$BRW < mean(p1$BRW) + (2.5 * sd(p1$BRW))), ]

brw_violin <- ggplot(p1, aes(x=factor(year), y=BRW, fill=factor(year))) + 
              geom_violin(color = "grey50") +
              stat_summary(fun.y=mean, geom="point", size=2, colour="white") +
              stat_summary(fun.y=median, geom="point", size=2, colour="red") + 
              facet_wrap( ~ GFZ, ncol = 2, scales = "free") + 
              theme(legend.position="none") +
              scale_y_continuous(labels = comma) +
              labs(x="",
                   y="Bodenrichtwert(€)",
                   title="Verteilung der Bodenrichtwerte (W-Wohngebiet) nach ausgewählter GFZ",
                   subtitle="Nominal prices (2002 - 2017); BRW means visualized as points, median in red",
                   caption="Quelle: FIS-Broker / Gutachterausschuss für Grundstückswerte in Berlin")

brw_violin

```

# Session Info

```{r}

   devtools::session_info()

```
